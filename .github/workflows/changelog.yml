# Auto-generate changelog on release
name: Generate Changelog

on:
  # Trigger on new releases
  release:
    types: [created, published]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      from_tag:
        description: 'From tag (leave empty for all commits)'
        required: false
        default: ''
      to_tag:
        description: 'To tag (default: HEAD)'
        required: false
        default: 'HEAD'

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Allow pushing changes
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for changelog generation
      
      - name: Generate changelog
        id: generate
        run: |
          echo "Generating changelog..."
          
          # Determine range
          if [ -n "${{ github.event.inputs.from_tag }}" ]; then
            FROM_TAG="${{ github.event.inputs.from_tag }}"
            TO_TAG="${{ github.event.inputs.to_tag }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            # Get previous tag
            CURRENT_TAG="${{ github.event.release.tag_name }}"
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
            FROM_TAG="$PREVIOUS_TAG"
            TO_TAG="$CURRENT_TAG"
          else
            FROM_TAG=""
            TO_TAG="HEAD"
          fi
          
          echo "From: $FROM_TAG"
          echo "To: $TO_TAG"
          
          # Generate changelog
          if [ -z "$FROM_TAG" ]; then
            bash scripts/generate_changelog.sh > CHANGELOG_AUTO.md
          else
            bash scripts/generate_changelog.sh "$FROM_TAG" "$TO_TAG" > CHANGELOG_AUTO.md
          fi
          
          # Check if there are changes
          if [ -s CHANGELOG_AUTO.md ]; then
            echo "changelog_generated=true" >> $GITHUB_OUTPUT
          else
            echo "changelog_generated=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Update CHANGELOG.md
        if: steps.generate.outputs.changelog_generated == 'true'
        run: |
          # Prepend new changelog to existing CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            # Backup existing changelog
            cp CHANGELOG.md CHANGELOG.md.bak
            
            # Create new changelog with auto-generated content
            cat CHANGELOG_AUTO.md > CHANGELOG.md.new
            echo "" >> CHANGELOG.md.new
            echo "---" >> CHANGELOG.md.new
            echo "" >> CHANGELOG.md.new
            echo "## Previous Entries" >> CHANGELOG.md.new
            echo "" >> CHANGELOG.md.new
            cat CHANGELOG.md.bak >> CHANGELOG.md.new
            
            mv CHANGELOG.md.new CHANGELOG.md
          else
            mv CHANGELOG_AUTO.md CHANGELOG.md
          fi
      
      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        if: steps.generate.outputs.changelog_generated == 'true'
        with:
          name: changelog
          path: |
            CHANGELOG.md
            CHANGELOG_AUTO.md
          retention-days: 30
      
      - name: Create Pull Request (optional)
        if: steps.generate.outputs.changelog_generated == 'true' && github.event_name == 'release'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs: Update CHANGELOG.md for ${{ github.event.release.tag_name }}"
          title: "Update CHANGELOG for ${{ github.event.release.tag_name }}"
          body: |
            Auto-generated changelog update for release ${{ github.event.release.tag_name }}
            
            This PR was automatically created by the changelog generation workflow.
          branch: changelog-${{ github.event.release.tag_name }}
          delete-branch: true
